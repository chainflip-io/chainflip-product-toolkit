name: Branch Publish üöÄ

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish'
        required: true
        type: choice
        options:
          - bitcoin
          - delegation
          - extrinsics
          - processor
          - redis
          - rpc
          - scale
          - solana
          - testing
          - utils
      npm_tag:
        description: 'NPM tag for the release'
        required: false
        type: string
        default: 'dev'

permissions:
  packages: write
  contents: read

jobs:
  get-node-version:
    uses: ./.github/workflows/_node_context.yml

  validate-version:
    runs-on: ubuntu-latest
    steps:
      - name: Validate npm tag
        run: |
          if [ "${{ inputs.npm_tag }}" = "latest" ]; then
            echo "Error: npm_tag cannot be 'latest' for branch publishes"
            exit 1
          fi

      - name: Checkout üõéÔ∏è
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Validate pre-release version
        run: |
          version=$(jq -r .version packages/${{ inputs.package }}/package.json)
          echo "Package version: $version"

          # Check if version has a pre-release suffix (e.g., -alpha.0, -beta.1, -rc.2)
          if [[ ! $version =~ ^[0-9]+\.[0-9]+\.[0-9]+-.+ ]]; then
            echo "Error: Version '$version' must have a pre-release suffix (e.g., -alpha.0, -beta.0, -rc.0)"
            exit 1
          fi

          echo "Valid pre-release version: $version"

  pre-checks:
    needs: [validate-version]
    uses: ./.github/workflows/_01_pre_checks.yml
    with:
      package: ${{ inputs.package }}
    secrets: inherit

  checks:
    needs: [pre-checks]
    uses: ./.github/workflows/_02_checks.yml
    with:
      package: ${{ inputs.package }}
    secrets: inherit

  publish:
    needs: [get-node-version, checks]
    uses: ./.github/workflows/_npm_publish.yml
    with:
      node_version: ${{ needs.get-node-version.outputs.node_version }}
      package_registry: 'https://registry.npmjs.org'
      package_scope: '@chainflip-io'
      build_cmd: pnpm --filter @chainflip/${{ inputs.package }} build
      publish_cmd: pnpm --filter @chainflip/${{ inputs.package }} publish --tag ${{ inputs.npm_tag }} --no-git-checks
      runs_on: namespace-profile-product-npm-publish
    secrets:
      node_auth_token: ${{ secrets.CF_NPM_JS_PACKAGES_READ_WRITE }}
